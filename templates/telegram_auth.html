<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</title>
</head>
<body>
    <h2>–ö—Ç–æ –≤—ã?</h2>
    <button onclick="initTelegramLogin(false)">–Ø –∫–ª–∏–µ–Ω—Ç</button>
    <button onclick="initTelegramLogin(true)">–Ø –ø—Å–∏—Ö–æ–ª–æ–≥</button>

    <div id="telegram-login-placeholder" style="margin-top: 20px;"></div>

    <script>
        function initTelegramLogin(isPsychologist) {
            const placeholder = document.getElementById('telegram-login-placeholder');
            placeholder.innerHTML = '';

            const script = document.createElement('script');
            script.setAttribute('async', '');
            script.src = "https://telegram.org/js/telegram-widget.js?22";
            script.setAttribute('data-telegram-login', 'aqlaq_test_bot');  // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞
            script.setAttribute('data-size', 'large');
            script.setAttribute('data-userpic', 'true');
            script.setAttribute('data-request-access', 'write');
            script.setAttribute('data-lang', 'ru');

            // üëá —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —ç—Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã JS –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
            const authUrl = "/telegram-auth/?wants_to_be_psychologist=" + isPsychologist;
            script.setAttribute('data-auth-url', authUrl);

            placeholder.appendChild(script);
        }

        // üëâ –ö–æ–≥–¥–∞ Telegram –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤ URL –±—É–¥—É—Ç query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –Ω–∞ –±—ç–∫–µ–Ω–¥ –≤—Ä—É—á–Ω—É—é
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);

            if (params.has('hash')) {
                fetch("/api/auth/telegram/?" + params.toString())
                    .then(res => res.json())
                    .then(data => {
                        console.log("–û—Ç–≤–µ—Ç –æ—Ç –±—ç–∫–µ–Ω–¥–∞:", data);

                        if (data.access_token) {
                            localStorage.setItem("access_token", data.access_token);
                            localStorage.setItem("refresh_token", data.refresh_token);
                            localStorage.setItem("user_id", data.user_id);
                            localStorage.setItem("role", data.role);

                            // –†–µ–¥–∏—Ä–µ–∫—Ç –∫—É–¥–∞ –Ω—É–∂–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ø—Ä–æ—Ñ–∏–ª—å
                            window.location.href = "/profile";
                        } else {
                            alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                        }
                    })
                    .catch(err => {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è");
                    });
            }
        });
    </script>
</body>
</html>